MODULE VARIABLES
    !         0           1           2            3            4            5            6            7            8            9            10           11           12           13           14           15           16           17           18
DOUBLE PRECISION,PARAMETER::WF(0:18)=[1.D0/3.D0,  1.D0/18.D0,  1.D0/18.D0,  1.D0/18.D0,  1.D0/18.D0,  1.D0/18.D0,  1.D0/18.D0,  1.D0/36.D0,  1.D0/36.D0,  1.D0/36.D0,  1.D0/36.D0,  1.D0/36.D0,  1.D0/36.D0,  1.D0/36.D0,  1.D0/36.D0,  1.D0/36.D0,  1.D0/36.D0,  1.D0/36.D0,  1.D0/36.D0] !WEIGHT COEFFICENT
DOUBLE PRECISION,PARAMETER::WG(0: 6)=[1.D0/4.D0,  1.D0/ 8.D0,  1.D0/ 8.D0,  1.D0/ 8.D0,  1.D0/ 8.D0,  1.D0/ 8.D0,  1.D0/ 8.D0]  
!                               0  1   2  3  4  5  6  7   8  9  10 11 12 13  14 15  16 17 18 / 0  1  2  3  4   5  6  7   8  9  10 11 12  13  14 15 16 17 18 / 0  1  2  3  4  5   6  7  8  9  10 11  12 13 14  15 16  17 18
INTEGER,PARAMETER::E(0:18,0:2)=[[0, 1, -1, 0, 0, 0, 0, 1, -1, 1, -1, 0, 0, 1, -1, 1, -1, 0, 0],[0, 0, 0, 1, -1, 0, 0, 1, -1, 0, 0, 1, -1, -1, 1, 0, 0, 1, -1],[0, 0, 0, 0, 0, 1, -1, 0, 0, 1, -1, 1, -1, 0, 0, -1, 1, -1, 1]]  !DIRECTIONS 
!                                  0 1 2 3 4 5 6 7 8  9 10 11 12 13  14 15  16 17 18
INTEGER,PARAMETER::OPPOSITE(0:18)=[0,2,1,4,3,6,5,8,7,10, 9,12,11,14, 13,16, 15,18,17]      !OPPOSITE DIRECTIONS FOR BOUNCE BACK

DOUBLE PRECISION::G,GE,PMIN,PMAX,DP,DPOLD,AF,ALPHA,A,B,TC,TR,DXYL,DXYV,T,R,DXYC,RHOMAX,RHOMIN,CV,CP,LANDA,TMP_RELAX,plane
DOUBLE PRECISION::INSQRT,INSQR,UMAX,GAMA,RADIUS,S_W,DXYW,NTH,DXYLL,DXYVV,DENSL,DENSV,KAPPA,SIGMA,VEL_SUM,FLOW_RATE,energy_diss
INTEGER::X,Y,Z,I,STEP,XR,XL,YT,YB,ZI,ZO,XMAX,YMAX,ZMAX,COUNT,II,JJ
INTEGER,DIMENSION(:,:,:),ALLOCATABLE::WALL
DOUBLE PRECISION,DIMENSION(:,:,:),ALLOCATABLE::U,V,W,DXY,USQR,UXY,VU,VV,VOR,S,F_SCX,F_SCY,F_SCZ,P,UP,VP,WP,UPP,VPP,WPP,USQRS,TXY,UREAL,VREAL,WREAL,VISCOSITY,RELAXATION,local_energy!,DPDT,DIVERGENCE,TGRAD,TDIVER
DOUBLE PRECISION,DIMENSION(:,:,:),ALLOCATABLE::Sab_XX,Sab_YY,Sab_ZZ,Sab_XY,Sab_XZ,Sab_YZ,RST_XX,RST_YY,RST_ZZ,RST_XY,RST_XZ,RST_YZ,INVARIANT,SHEAR,TMP_RST
DOUBLE PRECISION,DIMENSION(:,:,:),ALLOCATABLE::S_11,S_12,S_13,S_22,S_23,S_33,S_SQUARED,omega_SQUARED,Q_crit
DOUBLE PRECISION,DIMENSION(:,:,:,:),ALLOCATABLE::FIN,FEQ,FOUT,FX_GOU,FY_GOU,FZ_GOU,MFIN,MFEQ,TRANSFORMED,RELAXEDM,SS,MFX_GOU,MFY_GOU,MFZ_GOU,RELAXEDM_FX,RELAXEDM_FY,RELAXEDM_FZ,MRT_FX,MRT_FY,MRT_FZ,NEQ!,GIN,GEQ,GOUT,RELAXEDN,TRANSFORMEDN,MGIN,MGEQ,
DOUBLE PRECISION,PARAMETER::PI=3.1415926535897932,U0=0.D0,CS=1.D0/DSQRT(3.D0)
DOUBLE PRECISION,PARAMETER::BETA=1.0D0,TAU_T=0.98D0
DOUBLE PRECISION,PARAMETER::TAU=1D0,OMEGA=1D0/TAU,OMEGA_T=1D0/TAU_T,NU=(TAU-0.5D0)/CS**2
CHARACTER*20::MYFILE
INTEGER :: start, finish, rate
DOUBLE PRECISION :: elapsed_time

double precision ::dissipation_rate,energy_diss_old




CHARACTER(LEN=20) :: FILE_NAME


!SIGMA=-2.5D0

LOGICAL::S_C,P_R,R_K,C_S


DOUBLE PRECISION::M(19,19),MINV(19,19),N(7,7),NINV(7,7),SST(7,7)

integer::node_count

!                        1     2     3     4     5     6     7     8   9    10   11   12   13   14   15   16   17   18   19
DATA (M(1,I), I=1,19)/  1D0,  1D0,  1D0,  1D0,  1D0,  1D0,  1D0, 1D0, 1D0, 1D0, 1D0, 1D0, 1D0, 1D0, 1D0, 1D0, 1D0, 1D0, 1D0 / ! 1
DATA (M(2,I), I=1,19)/-30D0,-11D0,-11D0,-11D0,-11D0,-11D0,-11D0, 8D0, 8D0, 8D0, 8D0, 8D0, 8D0, 8D0, 8D0, 8D0, 8D0, 8D0, 8D0 / ! 2
DATA (M(3,I), I=1,19)/ 12D0, -4D0, -4D0, -4D0, -4D0, -4D0, -4D0, 1D0, 1D0, 1D0, 1D0, 1D0, 1D0, 1D0, 1D0, 1D0, 1D0, 1D0, 1D0 / ! 3
DATA (M(4,I), I=1,19)/  0D0,  1D0, -1D0,  0D0,  0D0,  0D0,  0D0, 1D0,-1D0, 1D0,-1D0, 0D0, 0D0, 1D0,-1D0, 1D0,-1D0, 0D0, 0D0 / ! 4
DATA (M(5,I), I=1,19)/  0D0, -4D0,  4D0,  0D0,  0D0,  0D0,  0D0, 1D0,-1D0, 1D0,-1D0, 0D0, 0D0, 1D0,-1D0, 1D0,-1D0, 0D0, 0D0 / ! 5 
DATA (M(6,I), I=1,19)/  0D0,  0D0,  0D0,  1D0, -1D0,  0D0,  0D0, 1D0,-1D0, 0D0, 0D0, 1D0,-1D0,-1D0, 1D0, 0D0, 0D0, 1D0,-1D0 / ! 6
DATA (M(7,I), I=1,19)/  0D0,  0D0,  0D0, -4D0,  4D0,  0D0,  0D0, 1D0,-1D0, 0D0, 0D0, 1D0,-1D0,-1D0, 1D0, 0D0, 0D0, 1D0,-1D0 / ! 7
DATA (M(8,I), I=1,19)/  0D0,  0D0,  0D0,  0D0,  0D0,  1D0, -1D0, 0D0, 0D0, 1D0,-1D0, 1D0,-1D0, 0D0, 0D0,-1D0, 1D0,-1D0, 1D0 / ! 8
DATA (M(9,I), I=1,19)/  0D0,  0D0,  0D0,  0D0,  0D0, -4D0,  4D0, 0D0, 0D0, 1D0,-1D0, 1D0,-1D0, 0D0, 0D0,-1D0, 1D0,-1D0, 1D0 / ! 9
DATA (M(10,I), I=1,19)/ 0D0,  2D0,  2D0, -1D0, -1D0, -1D0, -1D0, 1D0, 1D0, 1D0, 1D0,-2D0,-2D0, 1D0, 1D0, 1D0, 1D0,-2D0,-2D0 / ! 10
DATA (M(11,I), I=1,19)/ 0D0, -4D0, -4D0,  2D0,  2D0,  2D0,  2D0, 1D0, 1D0, 1D0, 1D0,-2D0,-2D0, 1D0, 1D0, 1D0, 1D0,-2D0,-2D0 / ! 11
DATA (M(12,I), I=1,19)/ 0D0,  0D0,  0D0,  1D0,  1D0, -1D0, -1D0, 1D0, 1D0,-1D0,-1D0, 0D0, 0D0, 1D0, 1D0,-1D0,-1D0, 0D0, 0D0 / ! 12
DATA (M(13,I), I=1,19)/ 0D0,  0D0,  0D0, -2D0, -2D0,  2D0,  2D0, 1D0, 1D0,-1D0,-1D0, 0D0, 0D0, 1D0, 1D0,-1D0,-1D0, 0D0, 0D0 / ! 13
DATA (M(14,I), I=1,19)/ 0D0,  0D0,  0D0,  0D0,  0D0,  0D0,  0D0, 1D0, 1D0, 0D0, 0D0, 0D0, 0D0,-1D0,-1D0, 0D0, 0D0, 0D0, 0D0 / ! 14
DATA (M(15,I), I=1,19)/ 0D0,  0D0,  0D0,  0D0,  0D0,  0D0,  0D0, 0D0, 0D0, 0D0, 0D0, 1D0, 1D0, 0D0, 0D0, 0D0, 0D0,-1D0,-1D0 / ! 15
DATA (M(16,I), I=1,19)/ 0D0,  0D0,  0D0,  0D0,  0D0,  0D0,  0D0, 0D0, 0D0, 1D0, 1D0, 0D0, 0D0, 0D0, 0D0,-1D0,-1D0, 0D0, 0D0 / ! 16
DATA (M(17,I), I=1,19)/ 0D0,  0D0,  0D0,  0D0,  0D0,  0D0,  0D0, 1D0,-1D0,-1D0, 1D0, 0D0, 0D0, 1D0,-1D0,-1D0, 1D0, 0D0, 0D0 / ! 17
DATA (M(18,I), I=1,19)/ 0D0,  0D0,  0D0,  0D0,  0D0,  0D0,  0D0,-1D0, 1D0, 0D0, 0D0, 1D0,-1D0, 1D0,-1D0, 0D0, 0D0, 1D0,-1D0 / ! 18
DATA (M(19,I), I=1,19)/ 0D0,  0D0,  0D0,  0D0,  0D0,  0D0,  0D0, 0D0, 0D0, 1D0,-1D0,-1D0, 1D0, 0D0, 0D0,-1D0, 1D0, 1D0,-1D0 / ! 19

DATA (N(1,I), I=1,7)/  1D0,  1D0,  1D0,  1D0,  1D0,  1D0,  1D0 /
DATA (N(2,I), I=1,7)/  0D0,  1D0, -1D0,  0D0,  0D0,  0D0,  0D0 /
DATA (N(3,I), I=1,7)/  0D0,  0D0,  0D0,  1D0, -1D0,  0D0,  0D0 /
DATA (N(4,I), I=1,7)/  0D0,  0D0,  0D0,  0D0,  0D0,  1D0, -1D0 /
DATA (N(5,I), I=1,7)/  6D0, -1D0, -1D0, -1D0, -1D0, -1D0, -1D0 /
DATA (N(6,I), I=1,7)/  0D0,  2D0,  2D0, -1D0, -1D0, -1D0, -1D0 /
DATA (N(7,I), I=1,7)/  0D0,  0D0,  0D0,  1D0,  1D0, -1D0, -1D0 /

!                                   1                       2                     3                      4                       5                     6                     7                      8                       9                    10                    11                    12                     13                     14                     15                     16                    17                    18                      19
DATA (MINV(1,I), I=1,19)/  0.052631578947368D0,  -0.012531328320802D0,   0.047619047619048D0,  -0.000000000000000D0,   0.000000000000000D0, 0.000000000000000D0,  -0.000000000000000D0,   0.000000000000000D0,  -0.000000000000000D0,   0.000000000000000D0, 0.000000000000000D0,  -0.000000000000000D0,   0.000000000000000D0,  0.000000000000000D0,   0.000000000000000D0,  0.000000000000000D0,   0.000000000000000D0,   0.000000000000000D0,   0.000000000000000D0/ ! 1
DATA (MINV(2,I), I=1,19)/ -0.052631578947368D0,  -0.004594820384294D0,  -0.015873015873016D0,   0.100000000000000D0,  -0.100000000000000D0, 0.000000000000000D0,  -0.000000000000000D0,  -0.000000000000000D0,  -0.000000000000000D0,   0.055555555555556D0,-0.055555555555556D0,  -0.000000000000000D0,  -0.000000000000000D0,  0.000000000000000D0,  -0.000000000000000D0, -0.000000000000000D0,   0.000000000000000D0,  -0.000000000000000D0,   0.000000000000000D0/ ! 2
DATA (MINV(3,I), I=1,19)/  0.052631578947368D0,  -0.004594820384294D0,  -0.015873015873016D0,  -0.100000000000000D0,   0.100000000000000D0,-0.000000000000000D0,  -0.000000000000000D0,  -0.000000000000000D0,  -0.000000000000000D0,   0.055555555555556D0,-0.055555555555556D0,   0.000000000000000D0,   0.000000000000000D0,  0.000000000000000D0,  -0.000000000000000D0,  0.000000000000000D0,   0.000000000000000D0,   0.000000000000000D0,   0.000000000000000D0/ ! 3
DATA (MINV(4,I), I=1,19)/  0.052631578947368D0,  -0.004594820384294D0,  -0.015873015873016D0,   0.000000000000000D0,   0.000000000000000D0, 0.100000000000000D0,  -0.100000000000000D0,  -0.000000000000000D0,  -0.000000000000000D0,  -0.027777777777778D0, 0.027777777777778D0,   0.083333333333333D0,  -0.083333333333333D0,  0.000000000000000D0,   0.000000000000000D0,  0.000000000000000D0,   0.000000000000000D0,  -0.000000000000000D0,  -0.000000000000000D0/ ! 4
DATA (MINV(5,I), I=1,19)/  0.052631578947368D0,  -0.004594820384294D0,  -0.015873015873016D0,   0.000000000000000D0,   0.000000000000000D0,-0.100000000000000D0,   0.100000000000000D0,  -0.000000000000000D0,  -0.000000000000000D0,  -0.027777777777778D0, 0.027777777777778D0,   0.083333333333333D0,  -0.083333333333333D0,  0.000000000000000D0,  -0.000000000000000D0,  0.000000000000000D0,   0.000000000000000D0,  -0.000000000000000D0,   0.000000000000000D0/ ! 5 
DATA (MINV(6,I), I=1,19)/  0.052631578947368D0,  -0.004594820384294D0,  -0.015873015873016D0,   0.000000000000000D0,   0.000000000000000D0, 0.000000000000000D0,   0.000000000000000D0,   0.100000000000000D0,  -0.100000000000000D0,  -0.027777777777778D0, 0.027777777777778D0,  -0.083333333333333D0,   0.083333333333333D0, -0.000000000000000D0,  -0.000000000000000D0,  0.000000000000000D0,  -0.000000000000000D0,  -0.000000000000000D0,   0.000000000000000D0/ ! 6
DATA (MINV(7,I), I=1,19)/  0.052631578947368D0,  -0.004594820384294D0,  -0.015873015873016D0,  -0.000000000000000D0,   0.000000000000000D0,-0.000000000000000D0,   0.000000000000000D0,  -0.100000000000000D0,   0.100000000000000D0,  -0.027777777777778D0, 0.027777777777778D0,  -0.083333333333333D0,   0.083333333333333D0, -0.000000000000000D0,  -0.000000000000000D0, -0.000000000000000D0,   0.000000000000000D0,  -0.000000000000000D0,   0.000000000000000D0/ ! 7
DATA (MINV(8,I), I=1,19)/  0.052631578947368D0,   0.003341687552214D0,   0.003968253968254D0,   0.100000000000000D0,   0.025000000000000D0, 0.100000000000000D0,   0.025000000000000D0,   0.000000000000000D0,   0.000000000000000D0,   0.027777777777778D0, 0.013888888888889D0,   0.083333333333333D0,   0.041666666666667D0,  0.250000000000000D0,   0.000000000000000D0,  0.000000000000000D0,   0.125000000000000D0,  -0.125000000000000D0,   0.000000000000000D0/ ! 8
DATA (MINV(9,I), I=1,19)/  0.052631578947368D0,   0.003341687552214D0,   0.003968253968254D0,  -0.100000000000000D0,  -0.025000000000000D0,-0.100000000000000D0,  -0.025000000000000D0,   0.000000000000000D0,   0.000000000000000D0,   0.027777777777778D0, 0.013888888888889D0,   0.083333333333333D0,   0.041666666666667D0,  0.250000000000000D0,  -0.000000000000000D0,  0.000000000000000D0,  -0.125000000000000D0,   0.125000000000000D0,  -0.000000000000000D0/ ! 9
DATA (MINV(10,I), I=1,19)/ 0.052631578947369D0,   0.003341687552214D0,   0.003968253968254D0,   0.100000000000000D0,   0.025000000000000D0,-0.000000000000000D0,  -0.000000000000000D0,   0.100000000000000D0,   0.025000000000000D0,   0.027777777777778D0, 0.013888888888889D0,  -0.083333333333333D0,  -0.041666666666667D0, -0.000000000000000D0,  -0.000000000000000D0,  0.250000000000000D0,  -0.125000000000000D0,  -0.000000000000000D0,   0.125000000000000D0/ ! 10
DATA (MINV(11,I), I=1,19)/ 0.052631578947368D0,   0.003341687552214D0,   0.003968253968254D0,  -0.100000000000000D0,  -0.025000000000000D0, 0.000000000000000D0,   0.000000000000000D0,  -0.100000000000000D0,  -0.025000000000000D0,   0.027777777777778D0, 0.013888888888889D0,  -0.083333333333333D0,  -0.041666666666667D0,  0.000000000000000D0,  -0.000000000000000D0,  0.250000000000000D0,   0.125000000000000D0,   0.000000000000000D0,  -0.125000000000000D0/ ! 11
DATA (MINV(12,I), I=1,19)/ 0.052631578947368D0,   0.003341687552214D0,   0.003968253968254D0,   0.000000000000000D0,   0.000000000000000D0, 0.100000000000000D0,   0.025000000000000D0,   0.100000000000000D0,   0.025000000000000D0,  -0.055555555555556D0,-0.027777777777778D0,  -0.000000000000000D0,  -0.000000000000000D0, -0.000000000000000D0,   0.250000000000000D0, -0.000000000000000D0,  -0.000000000000000D0,   0.125000000000000D0,  -0.125000000000000D0/ ! 12
DATA (MINV(13,I), I=1,19)/ 0.052631578947368D0,   0.003341687552214D0,   0.003968253968254D0,  -0.000000000000000D0,  -0.000000000000000D0,-0.100000000000000D0,  -0.025000000000000D0,  -0.100000000000000D0,  -0.025000000000000D0,  -0.055555555555556D0,-0.027777777777778D0,   0.000000000000000D0,   0.000000000000000D0, -0.000000000000000D0,   0.250000000000000D0,  0.000000000000000D0,   0.000000000000000D0,  -0.125000000000000D0,   0.125000000000000D0/ ! 13
DATA (MINV(14,I), I=1,19)/ 0.052631578947368D0,   0.003341687552214D0,   0.003968253968254D0,   0.100000000000000D0,   0.025000000000000D0,-0.100000000000000D0,  -0.025000000000000D0,  -0.000000000000000D0,  -0.000000000000000D0,   0.027777777777778D0, 0.013888888888889D0,   0.083333333333333D0,   0.041666666666667D0, -0.250000000000000D0,  -0.000000000000000D0, -0.000000000000000D0,   0.125000000000000D0,   0.125000000000000D0,  -0.000000000000000D0/ ! 14
DATA (MINV(15,I), I=1,19)/ 0.052631578947368D0,   0.003341687552214D0,   0.003968253968254D0,  -0.100000000000000D0,  -0.025000000000000D0, 0.100000000000000D0,   0.025000000000000D0,                   0D0,                   0D0,   0.027777777777778D0, 0.013888888888889D0,   0.083333333333333D0,   0.041666666666667D0, -0.250000000000000D0,   0.000000000000000D0,  0.000000000000000D0,  -0.125000000000000D0,  -0.125000000000000D0,   0.000000000000000D0/ ! 15
DATA (MINV(16,I), I=1,19)/ 0.052631578947368D0,   0.003341687552214D0,   0.003968253968254D0,   0.100000000000000D0,   0.025000000000000D0, 0.000000000000000D0,   0.000000000000000D0,  -0.100000000000000D0,  -0.025000000000000D0,   0.027777777777778D0, 0.013888888888889D0,  -0.083333333333333D0,  -0.041666666666667D0, -0.000000000000000D0,   0.000000000000000D0, -0.250000000000000D0,  -0.125000000000000D0,   0.000000000000000D0,  -0.125000000000000D0/ ! 16
DATA (MINV(17,I), I=1,19)/ 0.052631578947368D0,   0.003341687552214D0,   0.003968253968254D0,  -0.100000000000000D0,  -0.025000000000000D0,-0.000000000000000D0,  -0.000000000000000D0,   0.100000000000000D0,   0.025000000000000D0,   0.027777777777778D0, 0.013888888888889D0,  -0.083333333333333D0,  -0.041666666666667D0,                  0D0,                   0D0, -0.250000000000000D0,   0.125000000000000D0,  -0.000000000000000D0,   0.125000000000000D0/ ! 17
DATA (MINV(18,I), I=1,19)/ 0.052631578947368D0,   0.003341687552214D0,   0.003968253968254D0,  -0.000000000000000D0,  -0.000000000000000D0, 0.100000000000000D0,   0.025000000000000D0,  -0.100000000000000D0,  -0.025000000000000D0,  -0.055555555555556D0,-0.027777777777778D0,  -0.000000000000000D0,  -0.000000000000000D0, -0.000000000000000D0,  -0.250000000000000D0,  0.000000000000000D0,  -0.000000000000000D0,   0.125000000000000D0,   0.125000000000000D0/ ! 18
DATA (MINV(19,I), I=1,19)/ 0.052631578947368D0,   0.003341687552214D0,   0.003968253968254D0,   0.000000000000000D0,   0.000000000000000D0,-0.100000000000000D0,  -0.025000000000000D0,   0.100000000000000D0,   0.025000000000000D0,  -0.055555555555556D0,-0.027777777777778D0,  -0.000000000000000D0,  -0.000000000000000D0,  0.000000000000000D0,  -0.250000000000000D0, -0.000000000000000D0,  -0.000000000000000D0,  -0.125000000000000D0,  -0.125000000000000D0/ ! 19


DATA (NINV(1,I), I=1,7)/ 0.1429D0,    0D0,    0D0,    0D0,    0.1429D0,        0D0,      0D0     /
DATA (NINV(2,I), I=1,7)/ 0.1429D0,  0.5D0,    0D0,    0D0,   -0.0238D0,   0.1667D0,      0D0     /
DATA (NINV(3,I), I=1,7)/ 0.1429D0, -0.5D0,    0D0,    0D0,   -0.0238D0,   0.1667D0,      0D0     /
DATA (NINV(4,I), I=1,7)/ 0.1429D0,    0D0,  0.5D0,    0D0,   -0.0238D0,  -0.0833D0,      0.2500  /
DATA (NINV(5,I), I=1,7)/ 0.1429D0,    0D0, -0.5D0,    0D0,   -0.0238D0,  -0.0833D0,      0.2500  /
DATA (NINV(6,I), I=1,7)/ 0.1429D0,    0D0,    0D0,  0.5D0,   -0.0238D0,  -0.0833D0,     -0.2500  /
DATA (NINV(7,I), I=1,7)/ 0.1429D0,    0D0,    0D0, -0.5D0,   -0.0238D0,  -0.0833D0,     -0.2500  /   

END MODULE VARIABLES